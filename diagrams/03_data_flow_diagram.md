# 🔄 数据流程图

```mermaid
flowchart TD
    A[📧 接收邮件] --> B{邮件来源}
    
    B -->|IMAP| C[IMAP服务获取邮件]
    B -->|Gmail API| D[Gmail API获取邮件]
    
    C --> E[提取邮件内容<br/>MessageID, 主题, 正文]
    D --> E
    
    E --> F[📝 解析邮件主题]
    F --> G{主题格式检查}
    
    G -->|不符合格式| H[❌ 跳过处理<br/>记录日志: SKIPPED]
    G -->|符合格式| I[🔍 关键词匹配]
    
    I --> J{找到匹配目标?}
    J -->|否| H
    J -->|是| K[✅ 获取转发目标]
    
    K --> L[🔄 去重检查]
    L --> M{已转发过?}
    
    M -->|是| N[⏭️ 跳过重复转发<br/>记录日志: DUPLICATE]
    M -->|否| O[📤 准备转发]
    
    O --> P[🔧 邮件内容解码<br/>Quoted-Printable → 中文]
    P --> Q{发送方式}
    
    Q -->|优先SMTP| R[📮 SMTP发送]
    Q -->|Gmail API| S[📧 Gmail API发送]
    
    R --> T{发送成功?}
    S --> T
    
    T -->|成功| U[✅ 记录成功日志<br/>状态: FORWARDED]
    T -->|失败| V[❌ 记录失败日志<br/>状态: FAILED]
    
    U --> W[📊 统计更新]
    V --> W
    H --> W
    N --> W
    
    W --> X[🔄 继续监听新邮件]
    X --> A
    
    style A fill:#e1f5fe
    style U fill:#e8f5e8
    style V fill:#ffebee
    style H fill:#fff3e0
    style N fill:#f3e5f5
```

## 流程说明

### 📧 邮件接收阶段
1. **多源接收**: 支持IMAP和Gmail API两种方式
2. **内容提取**: 获取MessageID、主题、正文等关键信息
3. **格式验证**: 确保邮件主题符合 `内容 - 转发对象名字` 格式

### 🔍 智能匹配阶段  
1. **关键词解析**: 从主题中提取关键词和目标名称
2. **模糊匹配**: 支持关键词的模糊匹配
3. **目标查找**: 在数据库中查找匹配的转发目标

### 🔄 企业级去重阶段
1. **MessageID检查**: 基于邮件唯一标识符
2. **目标级去重**: 同一邮件可转发给多个目标，但不重复转发给同一目标
3. **状态记录**: 完整追踪处理状态

### 📤 智能转发阶段
1. **内容解码**: 处理中文Quoted-Printable编码
2. **多渠道发送**: SMTP优先，Gmail API备选
3. **格式标准化**: 使用标准转发格式

### 📊 监控统计阶段
1. **状态更新**: 实时更新处理状态
2. **错误处理**: 记录详细错误信息
3. **持续监听**: 自动循环处理新邮件 